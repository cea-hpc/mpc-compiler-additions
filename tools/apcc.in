#!/bin/sh

usage()
{
	printf "Usage: apcc [-fmpc-privatize] file\n"
	printf "    -f[no-]mpc-privatize     Enable/disable automatic privatization.\n"
	printf "    -f[no-]mpc-tlsopt        Enable/disable linker-optimized TLS.\n"
	printf "    -f[no]mpc-plugin         Enable/disable C dynamic initialization.\n"
	printf "    -f[no]mpc-dyn-insert     Enable/disable the 'wrapped TLS' dyn model.\n"
	printf "    -f[no]dump-dyn-tree      Enable/disable printing the dyn-related AST.\n"
	printf "    -show|--show             Print command line instead of running it.\n"
	printf "    -ap-h | --ap-help        Print this help.\n"
	printf "    <any GCC options>        Any GCC-compatible option will be forwarded.\n"
	printf "\n"
	printf "Useful environment variables:\n"
	printf "    - AP_CC                  Define the C compiler\n"
	printf "    - MPC_DYN_PRIV_DUMP      Same as '-fdump-dyn-tree'\n"
	printf "    - MPC_DYN_INSERT         Same as '-fdump-dyn-insert'\n"
}

inst=@prefix@

bin_inst=${inst}/bin
lib_inst=${inst}/lib
lib64_inst=${inst}/lib64

AP_PRE_CMD=""
AP_POST_CMD=""
AP_ENABLED_FLAG=""
AP_PLUGIN_FLAG="-fplugin=${lib_inst}/dynpriv.so"
AP_COMPILE="-L${lib_inst} -L${lib64_inst} -Wl,-rpath=${lib_inst} -Wl,-rpath=${lib64_inst}"
AP_LINK="-lextls"
AP_DOWNSTREAM_ARGS=""

test -z "$AP_CC" && AP_CC=@CC@

for arg in "$@";
do
	case $arg in
		-fmpc-privatize|-fmpcprivatize)
			export MPC_DYN_PRIV_ENABLED=1
			AP_ENABLED_FLAG="-fmpc-privatize -DAUTOPRIV_ENABLED"
			;;
		-fnompcprivatize|-fno-mpcprivatize|-fno-mpc-privatize|-fmpc-noprivatize|-fmpc-no-privatize|-fmpcnoprivatize)
			unset MPC_DYN_PRIV_ENABLED
			AP_ENABLED_FLAG=""
			;;
		-fmpc-tlsopt|-fmpctlsopt|-ftls-opt|-ftlsopt)
			unset MPC_DISABLE_TLS_OPT
			;;
		-fmpc-notlopt|-fmpcnotlsopt|-fno-mpctlsopt|-fnompctlsopt|-fnotlsopt|-fno-tlsopt)
			export MPC_DISABLE_TLS_OPT=1
			;;
		-fmpc-plugin|-fmpcplugin)
			AP_PLUGIN_FLAG="-fplugin=${lib_inst}/dynpriv.so"
			;;
		-fnompc-plugin|-fno-mpc-plugin|-fnompcplugin)
			AP_PLUGIN_FLAG=""
			;;
		-ap-h|--ap-help)
			usage
			exit 0
			;;
		-fmpc-dyninsert|-fmpcdyninsert|-fmpc-dyn-insert)
			export MPC_DYN_INSERT=1
			;;
		-fno-mpc-dyn-insert|-fno-mpc-dyninsert|-fno-mpcdyninsert|-fnompcdyninsert)
			unset MPC_DYN_INSERT
			;;
		-fdump-dyn-tree|-fdump-dyntree|-fdumpdyntree)
			export MPC_DYN_PRIV_DUMP=1
			;;
		-fno-dump-dyn-tree|-fno-dump-dyntree|-fno-dump-dyntree|-fnodumpdyntree)
			unset MPC_DYN_PRIV_DUMP
			;;
		-show|--show)
			AP_PRE_CMD="echo"
			AP_POST_CMD=""
			;;
		*)
			modarg=`echo "x$arg" | sed -e 's/^x//' -e 's/"/\\\"/g' -e s,\',%@%\',g -e 's/%@%/\\\/g' -e 's/ /\\\ /g' -e 's#(#\\\(#g' -e 's#)#\\\)#g'`
			AP_DOWNSTREAM_ARGS="$AP_DOWNSTREAM_ARGS $modarg"
			;;
	esac
done
$AP_PRE_CMD ${AP_CC} ${AP_COMPILE} ${AP_ENABLED_FLAG} ${AP_PLUGIN_FLAG} $AP_DOWNSTREAM_ARGS ${AP_LINK} $AP_POST_CMD
